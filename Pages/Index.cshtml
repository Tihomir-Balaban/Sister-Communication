@page
@model Sister_Communication.Pages.IndexModel

<h1>Sister Communication</h1>

<form method="post">
    <div style="margin-bottom: 12px;">
        <label>Google search term</label><br />
        <input asp-for="SearchTerm" />
        <button type="submit" asp-page-handler="Search">Search</button>
        <span asp-validation-for="SearchTerm"></span>
    </div>

    <div style="margin-bottom: 12px;">
        <label>Filter URLs in DB (SQL LIKE)</label><br />
        <input asp-for="DbFilterTerm" />
        <button type="submit" asp-page-handler="DbFilter">Filter</button>
        <button type="submit" asp-page-handler="ClearDbFilter">Clear DB filter</button>
        <span asp-validation-for="DbFilterTerm"></span>
    </div>

    <input type="hidden" asp-for="CurrentQuery" />

    <hr />

    <div style="margin: 12px 0;">
        <label>Realtime filter (frontend only)</label><br />
        <input id="realtimeFilter" type="text" placeholder="Type to filter displayed results..." />
        <button id="clearRealtimeFilter" type="button">Clear filter</button>
        <button id="toggleSort" type="button" data-sort="asc">Sort A → Z</button>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
    {
        var kind = Model.StatusKind ?? "info";
        var color = kind switch
        {
            "success" => "green",
            "warning" => "darkorange",
            "error"   => "crimson",
            _         => "black"
        };

        <div style="margin: 8px 0; font-weight: bold; color: @color;">
            @Model.StatusMessage
        </div>
    }

    @if (Model.Results.Any())
    {
        <table id="resultsTable">
            <thead>
            <tr>
                <th>#</th>
                <th>Title</th>
                <th>URL</th>
                <th>DisplayLink</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.Results)
            {
                <tr>
                    <td>@r.Position</td>
                    <td>@r.Title</td>
                    <td><a href="@r.Url" target="_blank">@r.Url</a></td>
                    <td>@r.DisplayLink</td>
                </tr>
            }
            </tbody>
        </table>
    }
</form>

@section Scripts
{
    <script>
        (function () {
            const filterInput = document.getElementById('realtimeFilter');
            const clearBtn = document.getElementById('clearRealtimeFilter');
            const sortBtn = document.getElementById('toggleSort');
            const table = document.getElementById('resultsTable');

            if (!table) return;

            const tbody = table.querySelector('tbody');
            const getRows = () => Array.from(tbody.querySelectorAll('tr'));

            function rowText(row) {
                return row.innerText.toLowerCase();
            }

            function applyFilter() {
                const term = (filterInput.value || '').trim().toLowerCase();
                const rows = getRows();

                if (!term) {
                    rows.forEach(r => r.style.display = '');
                    return;
                }

                rows.forEach(r => {
                    r.style.display = rowText(r).includes(term) ? '' : 'none';
                });
            }

            function clearFilter() {
                filterInput.value = '';
                applyFilter();
            }

            function sortRows(desc) {
                const rows = getRows();

                rows.sort((a, b) => {
                    const aUrl = (a.cells[2]?.innerText || '').toLowerCase();
                    const bUrl = (b.cells[2]?.innerText || '').toLowerCase();

                    if (aUrl < bUrl) return desc ? 1 : -1;
                    if (aUrl > bUrl) return desc ? -1 : 1;
                    return 0;
                });

                rows.forEach(r => tbody.appendChild(r));
            }

            function toggleSort() {
                const current = sortBtn.getAttribute('data-sort') || 'asc';
                const nextIsDesc = current === 'asc';

                sortRows(nextIsDesc);

                sortBtn.setAttribute('data-sort', nextIsDesc ? 'desc' : 'asc');
                sortBtn.textContent = nextIsDesc ? 'Sort Z → A' : 'Sort A → Z';
            }

            filterInput.addEventListener('input', applyFilter);
            clearBtn.addEventListener('click', clearFilter);
            sortBtn.addEventListener('click', toggleSort);
        })();
    </script>
}